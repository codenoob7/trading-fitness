# metrics-rust package - mise configuration
# Rust ITH library with Python bindings (PyO3/maturin)
# Inherits from root mise.toml

[env]
# Package-specific environment
METRICS_RUST_DIR = "{{config_root}}"

# =============================================================================
# Build Tasks
# =============================================================================

[tasks.build]
description = "Build metrics-rust Rust library"
run = "cargo build -p trading-fitness-metrics"

[tasks."build:release"]
description = "Build metrics-rust in release mode"
run = "cargo build -p trading-fitness-metrics --release"

[tasks."build:wheel"]
description = "Build Python wheel for distribution"
run = "maturin build --features python --release"

# =============================================================================
# Test Tasks
# =============================================================================

[tasks.test]
description = "Test metrics-rust (Rust unit + integration)"
run = "cargo nextest run -p trading-fitness-metrics"

[tasks."test:doc"]
description = "Test documentation examples"
run = "cargo test --doc -p trading-fitness-metrics"

[tasks."test:rolling"]
description = "Test rolling ITH features"
run = "cargo nextest run -p trading-fitness-metrics rolling"

[tasks."test:normalize"]
description = "Test ITH normalization functions"
run = "cargo nextest run -p trading-fitness-metrics normalize"

[tasks."test:multiscale"]
description = "Test multi-scale ITH (Rust unit tests)"
run = "cargo nextest run -p trading-fitness-metrics multiscale"

[tasks."test:all"]
description = "Full test suite (unit + doc + rebuild bindings)"
depends = ["test", "test:doc", "develop"]

# =============================================================================
# Development Tasks
# =============================================================================

[tasks.develop]
description = "Build Python bindings and install into ith-python venv"
run = """
unset VIRTUAL_ENV

# Use the ith-python venv's Python explicitly
PYTHON_BIN="../ith-python/.venv/bin/python"
if [ ! -f "$PYTHON_BIN" ]; then
    echo "ith-python venv not found. Running uv sync first..."
    cd ../ith-python && uv sync && cd ../metrics-rust
fi

PYTHON_VER=$("$PYTHON_BIN" --version | cut -d' ' -f2 | cut -d. -f1-2)
echo "Building wheel for Python $PYTHON_VER"

maturin build --features python --manifest-path Cargo.toml -i "$PYTHON_BIN"

WHEEL=$(realpath ../../target/wheels/trading_fitness_metrics-*cp${PYTHON_VER//./}*.whl 2>/dev/null | sort -r | head -1)
if [ -z "$WHEEL" ]; then
    echo "No wheel found for Python $PYTHON_VER"
    ls -la ../../target/wheels/
    exit 1
fi

echo "Installing wheel: $WHEEL"
cd ../ith-python && uv pip install "$WHEEL" --reinstall
echo "âœ… Wheel installed successfully"
"""

# =============================================================================
# Benchmark Tasks
# =============================================================================

[tasks.bench]
description = "Run all benchmarks"
run = "cargo bench -p trading-fitness-metrics"

[tasks."bench:multiscale"]
description = "Benchmark multi-scale ITH computation"
run = "cargo bench -p trading-fitness-metrics -- multiscale"

# =============================================================================
# Lint Tasks
# =============================================================================

[tasks.lint]
description = "Lint with clippy"
run = "cargo clippy -p trading-fitness-metrics -- -D warnings"

[tasks.fmt]
description = "Format code"
run = "cargo fmt -p trading-fitness-metrics"

[tasks."fmt:check"]
description = "Check formatting"
run = "cargo fmt -p trading-fitness-metrics -- --check"
